name: Build Application
run-name: Build [${{ inputs.branch }}] • ${{ inputs.build_type }} • ${{ inputs.tracker_id || 'N/A' }}


on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'
        type: string
      build_type:
        description: 'Type of build to perform'
        required: false
        default: 'standard'
        type: choice
        options:
          - compile-only
          - test-only
          - workflow-validation
          - standard
          - workflow-import
          - both
      tracker_id:
        description: 'Unique tracker ID for identifying this run'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Compile only (report all compilation errors)
      if: ${{ inputs.build_type == 'compile-only' || inputs.build_type == 'workflow-validation' }}
      run: |
        echo "::notice::Starting compilation check for branch ${{ inputs.branch }}"
        # Clean first to ensure a full recompile so all diagnostics are surfaced
        # Use --continue so Gradle doesn't stop at the first failing task
        # Use --console=plain and -i to make sure all javac diagnostics are printed in GH Actions logs
        ./gradlew clean compileJava --continue --console=plain -i
        status=$?
        if [ $status -eq 0 ]; then
          echo "::notice::✅ Compilation successful - no errors found"
          echo "COMPILE_STATUS=success" >> $GITHUB_ENV
        else
          echo "::error::❌ Compilation failed - see above for all reported errors"
          echo "COMPILE_STATUS=failure" >> $GITHUB_ENV
          exit 1
        fi

    - name: Run tests
      if: ${{ inputs.build_type == 'standard' || inputs.build_type == 'test-only' }}
      run: ./gradlew test

    - name: Run workflow validation test
      if: ${{ inputs.build_type == 'workflow-validation' }}
      run: ./gradlew test --tests WorkflowComponentValidationStandaloneTest

    - name: Build standard JAR
      if: ${{ inputs.build_type == 'standard' || inputs.build_type == 'both' }}
      run: ./gradlew bootJar

    - name: Build workflow import JAR
      if: ${{ inputs.build_type == 'workflow-import' || inputs.build_type == 'both' }}
      run: ./gradlew bootJarWorkflowImport

    - name: Upload standard build artifacts
      if: ${{ inputs.build_type == 'standard' || inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: standard-jar-${{ inputs.branch }}
        path: build/libs/*-SNAPSHOT.jar
        retention-days: 30

    - name: Upload workflow import build artifacts
      if: ${{ inputs.build_type == 'workflow-import' || inputs.build_type == 'both' }}
      uses: actions/upload-artifact@v4
      with:
        name: workflow-import-jar-${{ inputs.branch }}
        path: build/libs/*-workflow-import.jar
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ inputs.branch }}
        path: build/test-results/test/
        retention-days: 7

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ inputs.branch }}
        path: build/reports/tests/test/
        retention-days: 7

  summary:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "## 🚀 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Branch** | \`${{ inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Build Type** | \`${{ inputs.build_type }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Tracker ID** | \`${{ inputs.tracker_id || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Status** | ${{ needs.build.result == 'success' && '✅ Success' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Triggered by** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Run ID** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ inputs.build_type }}" == "compile-only" ]]; then
          echo "### 🔍 Compilation Check Results" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "✅ **All Java files compiled successfully** - No compilation errors found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Compilation failed** - Please check the build logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
        elif [[ "${{ inputs.build_type }}" == "workflow-validation" ]]; then
          echo "### 🔍 Workflow Validation Results" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "✅ **All workflow components validated successfully** - All processors and criteria have corresponding Java implementations!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Workflow validation failed** - Some processors or criteria are missing their Java implementation files. Please check the build logs for details." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### 📦 Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts are available in the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for 30 days." >> $GITHUB_STEP_SUMMARY
        fi
